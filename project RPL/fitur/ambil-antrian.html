<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ambil Antrian - Klinik Unsri</title>
    <link rel="stylesheet" href="ambil-antrian.css">
</head>
<body>
    <div class="container">
        <!-- Top Navigation -->
        <nav class="top-nav">
            <a href="../home.html" class="top-nav-item">
                <div class="top-nav-icon">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/>
                    </svg>
                </div>
                <span class="top-nav-label">Beranda</span>
            </a>
            <a href="../user/profile.html" class="top-nav-item">
                <div class="top-nav-icon">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
                    </svg>
                </div>
                <span class="top-nav-label">Profil</span>
            </a>
            <a href="../user/riwayat.html" class="top-nav-item">
                <div class="top-nav-icon">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M14 2H6c-1.1 0-1.99.9-1.99 2L4 20c0 1.1.89 2 1.99 2H18c1.1 0 2-.9 2-2V8l-6-6zm2 16H8v-2h8v2zm0-4H8v-2h8v2zm-3-5V3.5L18.5 9H13z"/>
                    </svg>
                </div>
                <span class="top-nav-label">Riwayat</span>
            </a>
        </nav>

        <!-- Header with Back Button -->
        <div class="header">
            <a href="../home.html" class="back-btn">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="white">
                    <path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"/>
                </svg>
                Kembali
            </a>
            <h1 class="page-title">Tertib Dan Mudah</h1>
        </div>

        <!-- Content -->
        <div class="content">
    <div class="antrian-display">
        <p class="label">Nomor Antrianmu</p>
        <div class="nomor-antrian">XX</div>
    </div>

    <div class="form-container">
    <div class="custom-select-wrapper">
        <label for="pilihanDokter" class="input-label">Pilih Dokter / Poli:</label>
        
        <div class="select-box">
            <select id="pilihanDokter" class="custom-select">
                <option value="" disabled selected>-- Silakan Pilih --</option>
                <option value="Dr. Umum">Dr. Umum (Ruang 01)</option>
                <option value="Dr. Gigi">Dr. Gigi (Ruang 02)</option>
                <option value="Dr. Anak">Dr. Anak (Ruang 03)</option>
            </select>
            <div class="select-icon">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M6 9l6 6 6-6"/>
                </svg>
            </div>
        </div>
    </div>
</div>
    <button class="btn-generate">Generate</button>
    <p class="note">Catatan: Pastikan kamu telah berada ditempat 5 menit sebelum panggilan</p>
</div>

<script>
    // Fungsi untuk mengubah tampilan jadi "Sudah Diambil" (Grey Box)
    function setTampilanSudahAmbil(nomor) {
        // Tampilkan Nomor
        document.querySelector('.nomor-antrian').innerText = nomor;
        
        // Ubah Tombol jadi Abu-abu & Mati
        const btn = document.querySelector('.btn-generate');
        btn.style.backgroundColor = "#cccccc"; // Warna Abu-abu
        btn.style.cursor = "not-allowed";
        btn.innerText = "Sudah Diambil";
        btn.disabled = true; // Mematikan fungsi klik
    }

    // FUNGSI 1: Cek Status Saat Halaman Dibuka
    async function cekStatusAwal() {
        const userId = localStorage.getItem('id_user');
        const token = localStorage.getItem('token_user');

        if (!userId || !token) return; // Kalau belum login, biarkan saja (nanti dicek saat klik)

        try {
            // Panggil endpoint baru kita
            const response = await fetch(`http://localhost:3000/antrian/check/${userId}`);
            const result = await response.json();

            // Jika backend bilang "exists: true", langsung ubah tampilan
            if (result.exists) {
                console.log("User sudah punya antrian:", result.data);
                setTampilanSudahAmbil(result.data.nomor_antrian);
            }

        } catch (error) {
            console.error("Gagal cek status awal:", error);
        }
    }

    // Jalankan pengecekan saat loading
    cekStatusAwal();

    // FUNGSI 2: Tombol Generate
    document.querySelector('.btn-generate').addEventListener('click', async () => {
        const token = localStorage.getItem('token_user');
        const namaUser = localStorage.getItem('nama_user');
        const userId = localStorage.getItem('id_user') || 1; 

        if(!token) {
            alert("Silakan login terlebih dahulu!");
            window.location.href = '../user/login.html';
            return;
        }

        // --- PERUBAHAN DI SINI: AMBIL DARI DROPDOWN ---
        const dokterPilihan = document.getElementById('pilihanDokter').value;

        // Validasi: User wajib pilih dokter dulu
        if (!dokterPilihan) {
            alert("Mohon pilih Dokter / Poli terlebih dahulu!");
            return; // Stop proses, jangan kirim ke backend
        }
        // ---------------------------------------------

        try {
            const response = await fetch('http://localhost:3000/antrian', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    user_id: userId,
                    nama_pasien: namaUser,
                    nama_dokter: dokterPilihan // <--- Kirim variabel ini
                })
            });

            // ... (Sisa kode ke bawah SAMA PERSIS) ...
            
            const result = await response.json();

            if(response.ok) {
                setTampilanSudahAmbil(result.data.nomor);
                
                // Tambahan: Disable dropdown juga biar gak bisa ganti-ganti lagi
                document.getElementById('pilihanDokter').disabled = true; 
                
                alert("Berhasil! Nomor antrian kamu: " + result.data.nomor + " di " + result.data.dokter);
            }

        } catch (error) {
            console.error(error);
            alert("Gagal koneksi ke server.");
        }
    });
</script>

</body>
</html>